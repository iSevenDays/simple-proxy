---
title: Fix harmony parsing when tool calls are made
issue: 10
status: closed
epic: harmony-support
created: 2025-08-28T09:30:00Z
updated: 2025-08-28T11:45:00Z
parallel: true
priority: high
github: https://github.com/iSevenDays/simple-proxy/issues/10
---

# Issue #10 - Fix Harmony Parsing When Tool Calls Are Made

## Problem Statement

Harmony parsing is not working correctly when tool calls are made. The Claude Code UI logs show raw Harmony tokens being displayed instead of properly processed thinking content, specifically when tools are involved.

## Evidence from Logs

**Claude Code UI showing raw tokens:**
```
‚è∫ <|channel|>analysis<|message|>The user wants to "use LS tool in this folder". We need to interpret what exactly they're asking. They probably want to list files in the current working directory (which is /private/tmp per env). Or maybe they want to list files in this folder (the current directory). The LS tool takes an absolute path to a directory, not relative. We need to call LS with path="/private/tmp". That will list files and directories. We should be mindful of the instructions: Use LS to list files and directories in a given path. The path must be absolute. The output will be returned. So we should call LS tool. Thus we need to respond with a tool call. We have a tool "LS". So we need to produce a JSON request: LS with {"path": "/private/tmp"}. Then after receiving the result, we can output it. The user just asked "use LS tool in this folder". So we should run LS and present the output. Thus the next step is to send a tool call to LS. <|end|>

‚è∫ List(/private/tmp)
  ‚éø  Listed 24 paths (ctrl+r to expand)
```

**Simple Proxy logs show:**
- Harmony tokens are NOT detected: `üîç No Harmony tokens detected in content`
- Content contains clear Harmony format with `<|channel|>analysis<|message|>...`

## Analysis

This indicates that:

1. **Harmony Detection Issue**: The content clearly contains Harmony tokens but `IsHarmonyFormat()` returns false
2. **Tool Call Context**: The issue specifically occurs when tool calls are involved
3. **Response Processing**: The content is being treated as non-Harmony, causing raw tokens to display

## Root Cause Investigation

Possible issues:
1. **Harmony Detection Logic**: `parser.IsHarmonyFormat()` may not handle tool call scenarios correctly
2. **Content Structure**: Tool call responses may have different content structure that breaks detection
3. **Regex Patterns**: The detection patterns may not account for tool call formatting
4. **Transformation Logic**: Special handling needed for tool calls with Harmony content

## Technical Requirements

1. **Fix Harmony Detection**: Ensure `IsHarmonyFormat()` correctly identifies Harmony content with tool calls
2. **Tool Call Handling**: Proper processing of commentary channel for tool calls  
3. **Content Extraction**: Correct extraction of thinking content from analysis channel
4. **Response Format**: Proper formatting for Claude Code UI display

## Success Criteria

- Tool call scenarios with Harmony content are properly detected
- Analysis channel content is extracted as thinking content
- Commentary/final channel content displays correctly 
- No raw Harmony tokens visible in Claude Code UI
- Debug logs show correct Harmony processing

## Files to Investigate

- `parser/harmony.go` - Detection and parsing logic
- `proxy/transform.go` - Response transformation with tool calls
- Test files for tool call scenarios with Harmony content

## Implementation Summary

### Parallel Work Streams Completed

**Stream A - Harmony Detection Investigation** ‚úÖ
- **Root Cause Found**: `HasHarmonyTokens()` only checked `<|start|>` or `<|end|>` tokens
- **Issue**: Tool calls contain `<|channel|>` and `<|message|>` without `<|start|>`/`<|end|>`
- **Location**: `parser/harmony.go` lines 634-635

**Stream B - Content Structure Analysis** ‚úÖ  
- **Content Validation**: Partial Harmony format without `<|start|>` token confirmed
- **Parser Compatibility**: Should work with existing logic
- **Conclusion**: Detection logic needs extension, not content restructuring

**Stream C - Parser Logic Enhancement** ‚úÖ
- **Fix Implemented**: Extended `HasHarmonyTokens()` to include channel/message detection
- **Code Change**:
  ```go
  func (tr *TokenRecognizer) HasHarmonyTokens(content string) bool {
      return tr.startPattern.MatchString(content) || 
             tr.endPattern.MatchString(content) ||
             tr.channelPattern.MatchString(content) || 
             tr.messagePattern.MatchString(content)
  }
  ```
- **Tests Added**: `TestIssue10_ToolCallHarmonyDetection()` and enhanced coverage
- **Commit**: `006f345` - "Issue #10: Fix Harmony detection for tool call scenarios"

**Stream D - Integration Testing** ‚úÖ
- **Pipeline Validated**: Detection ‚Üí Parsing ‚Üí Transformation ‚Üí UI display
- **Critical Test Case**: Exact failing content from GitHub issue now works
- **No Regressions**: All existing functionality preserved

### Resolution

**Root Cause**: The `HasHarmonyTokens()` function only detected content with `<|start|>` or `<|end|>` tokens, missing tool call scenarios that contained `<|channel|>analysis<|message|>...` patterns.

**Solution**: Extended the detection logic to also check for `channelPattern` and `messagePattern`, enabling proper detection of partial Harmony sequences commonly seen in tool call scenarios.

**Result**: Tool call scenarios with Harmony content are now:
- ‚úÖ Properly detected as Harmony format
- ‚úÖ Thinking content extracted from analysis channel  
- ‚úÖ Displayed correctly in Claude Code UI
- ‚úÖ No raw tokens visible to users

**Files Modified**:
- `/parser/harmony.go` - Enhanced detection logic
- `/parser/harmony_test.go` - Added comprehensive test coverage

**Impact**: Issue #10 completely resolved with full test coverage and no regressions.