# Issue #20: Fix Harmony Channel Extraction Logic

**Epic**: harmony-fixes  
**Sprint**: 2 (Week 2 - Core Implementation)  
**Priority**: Critical  
**Type**: Bug Fix  
**Estimated Effort**: 0.5 days
**Status**: Completed âœ…
**Started**: 2025-08-28T20:40:31Z
**Completed**: 2025-08-29T06:35:00Z
**Last Sync**: 2025-08-29T06:31:21Z
**GitHub**: https://github.com/iSevenDays/simple-proxy/issues/20

## Issue Description

Fix the Content Source Priority Inversion identified in the analysis phase that causes raw Harmony tokens to appear instead of clean extracted content.

## Root Cause Analysis

**Location**: `parser/harmony.go` lines 571, 587, 593  
**Problem**: Regex patterns only support `<|end|>` tokens but actual content uses `<|return|>` tokens  
**Impact**: Parser detects Harmony format but fails to extract channel content (channels=0), falling back to raw token display

## Technical Implementation

### Required Changes

1. **Line 571** - Update endPattern:
```go
// FROM:
endPattern, err := regexp.Compile(`<\|end\|>`)

// TO:
endPattern, err := regexp.Compile(`<\|(?:end|return)\|>`)
```

2. **Line 587** - Update fullPattern:
```go
// FROM:
fullPattern, err := regexp.Compile(`(?s)<\|start\|>(\w+)(?:<\|channel\|>(\w+))?<\|message\|>(.*?)<\|end\|>`)

// TO:
fullPattern, err := regexp.Compile(`(?s)<\|start\|>(\w+)(?:<\|channel\|>(\w+))?<\|message\|>(.*?)<\|(?:end|return)\|>`)
```

3. **Line 593** - Update partialPattern:
```go
// FROM:
partialPattern, err := regexp.Compile(`(?s)<\|channel\|>(\w+)<\|message\|>(.*?)<\|end\|>`)

// TO:
partialPattern, err := regexp.Compile(`(?s)<\|channel\|>(\w+)<\|message\|>(.*?)<\|(?:end|return)\|>`)
```

## Acceptance Criteria

- [ ] **Pattern Recognition**: Parser supports both `<|end|>` and `<|return|>` termination tokens
- [ ] **Content Extraction**: Clean content extracted from `final` channel without raw tokens
- [ ] **Test Validation**: `TestHarmonyMultiChannelParsing` passes
- [ ] **Edge Case Handling**: `TestHarmonyMalformedContentHandling` passes  
- [ ] **No Regression**: All existing tests continue to pass

## Test Validation

Run these tests to verify the fix:
```bash
cd /Users/seven/Documents/projects/simple-proxy
go test -v ./test -run "TestHarmonyMultiChannelParsing|TestHarmonyMalformedContentHandling"
```

## Definition of Done

- [ ] All three regex patterns updated in `parser/harmony.go`
- [ ] TDD tests pass showing clean content extraction
- [ ] Raw Harmony tokens no longer appear in Claude Code UI
- [ ] Commit message follows format: "Issue #20: Fix Harmony channel extraction for <|return|> tokens"
- [ ] Changes tested and validated

## Dependencies

- **Builds On**: Analysis findings from Issue #12/#17 (completed)
- **Validates With**: TDD test suite from Issue #13/#19 (completed)
- **Blocks**: Issues #21 (performance) and #22 (edge cases) optimizations

---
github: https://github.com/iSevenDays/simple-proxy/issues/23
**This is the critical fix that resolves the main user-facing bug where raw Harmony structural tokens appear instead of clean, formatted content.**