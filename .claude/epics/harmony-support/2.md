---
name: Implement Core Harmony Parser
status: closed
created: 2025-08-27T05:48:36Z
updated: 2025-08-27T07:11:14Z
github: https://github.com/iSevenDays/simple-proxy/issues/2
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Implement Core Harmony Parser

## Description
Create the core parser module (`parser/harmony.go`) that recognizes and parses OpenAI Harmony message format tokens. This foundational component handles token recognition, channel classification, and content extraction with graceful error handling.

## Acceptance Criteria
- [ ] `parser/harmony.go` module created with exported parsing functions
- [ ] Regex patterns compiled for efficient token recognition (`<|start|>`, `<|channel|>`, `<|message|>`, `<|end|>`)
- [ ] Channel classification logic (analysis → thinking, final → response, commentary → tool)
- [ ] Role extraction (assistant, user, system, developer, tool)
- [ ] Graceful handling of malformed Harmony tokens
- [ ] Support for both complete and streaming response parsing
- [ ] Unit tests covering all format examples from PRD
- [ ] Performance benchmark showing <5ms parsing time for typical messages

## Technical Details
- **Implementation approach**: Regex-based parsing with compiled patterns for performance
- **Key considerations**: 
  - Must handle partial/malformed input gracefully
  - Support streaming responses (incomplete tokens)
  - Zero external dependencies
- **Code locations**: Create `parser/harmony.go` package
- **Key functions**:
  - `ParseHarmonyMessage(content string) (*HarmonyMessage, error)`
  - `IsHarmonyFormat(content string) bool`
  - `ExtractChannels(content string) []Channel`

## Dependencies
- [ ] No external dependencies
- [ ] Existing Go project structure

## Effort Estimate
- Size: M
- Hours: 16-20 hours
- Parallel: true (independent foundation component)

## Definition of Done
- [ ] Code implemented with exported API
- [ ] Unit tests written and passing (>95% coverage)
- [ ] Performance benchmarks created and meeting targets
- [ ] Code follows project Go conventions
- [ ] Documentation comments added to public functions
