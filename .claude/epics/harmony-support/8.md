---
title: Fix harmony parsing
issue: 8
status: open
epic: harmony-support
created: 2025-08-28T06:45:00Z
parallel: false
priority: high
---

# Issue #8 - Fix Harmony Parsing

## Problem Statement

The Harmony parsing system is detecting Harmony tokens but failing to extract channels properly. The debug logs show:

```
[08:28:22.981] [DEBUG] [req:req_2000] üîç Harmony tokens detected, performing full extraction
[08:28:22.981] [DEBUG] [req:req_2000] üîç Harmony tokens found but no channels extracted - treating as non-Harmony
```

## Analysis

The issue occurs when:
1. `parser.IsHarmonyFormat()` returns `true` (tokens are detected)
2. `parser.ExtractChannels()` returns an empty array (channels are not extracted)
3. The system falls back to non-Harmony processing

From the log data, we can see the actual Harmony content that's failing:
```
<|channel|>analysis<|message|>The conversation: user asks \"interesting!\" (possibly a comment). We need to respond concisely, following guidelines: less than 4 lines, minimal. Likely respond with a short statement. Might ask if they have any specific request? The instruction says to be concise, no preamble. Possibly respond \"What would you like to work on?\" Keep under 4 lines. Use minimal text.\n\n<|end|>What would you like to work on today?
```

## Root Cause

The issue appears to be in the channel extraction regex logic in the parser implementation. The tokens are being detected correctly, but the regex patterns for extracting the actual channels are not matching the content structure.

## Technical Requirements

1. **Fix Channel Extraction**: Ensure `parser.ExtractChannels()` properly parses Harmony formatted content
2. **Regex Pattern Validation**: Verify regex patterns match the actual Harmony format structure
3. **Comprehensive Testing**: Add test cases for the specific failing format
4. **Debug Logging**: Enhance logging to show what patterns are being matched/not matched

## Success Criteria

- Harmony content with proper tokens gets channels extracted successfully
- Debug logs show proper channel extraction instead of fallback to non-Harmony
- All existing Harmony parsing tests continue to pass
- New test cases cover the specific failing format from the issue

## Files to Investigate

- `parser/harmony.go` - Core parsing logic and regex patterns
- `proxy/transform.go` - Integration point where parsing is called
- Test files for Harmony parsing functionality

## Test Cases to Add

1. Test case with the exact failing content from the logs
2. Various channel formats (analysis, final, commentary)
3. Edge cases with escaped characters or special formatting
4. Malformed Harmony content (should gracefully degrade)